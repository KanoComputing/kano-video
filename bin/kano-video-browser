#!/usr/bin/kano-splash /usr/share/kano-video/media/images/splash.png /usr/bin/env python

# Copyright (C) 2015 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU GPL v2
#
# Command line wrapper to Kano Video Midori version to watch YouTube videos
#

from kano.gtk3.kano_dialog import KanoDialog
from kano.utils import run_cmd, get_home, is_model_2_b
from kano.logging import logger
from kano_settings.system.advanced import get_parental_level

import shutil
import os
import sys

if __name__ == '__main__' and __package__ is None:
    dir_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
    if dir_path != '/usr':
        sys.path.insert(1, dir_path)

try:
    from kano_profile.tracker import Tracker
    kanotracker = Tracker()
except:
    pass


def jackd_running():
    try:
        pid = os.popen('pidof jackd').read()
        if len(pid):
            return True
    except:
        pass

    return False


def jackd_start(jackd='jackd -p32 -dalsa -dhw:0,0 -p1024 -n3 -s'):
    # Start jackd in the background, discarding console output
    cmdline = '/bin/bash -c "{} > /dev/null 2>&1" & '.format(jackd)
    rc = os.system(cmdline)
    return (rc == 0)


def jackd_stop():
    run_cmd('pkill jackd')


def main():
    jackd_started = False

    midori_skel = '/etc/skel/.config/midori/youtube'
    midori_config_dir = '.config/midori/youtube'

    # Make sure jackd is up and running
    if not jackd_running():
        jackd_started = True
        jackd_start()

    # Configuration directory contains Midori per-user cookies and extra stuff
    full_user_path = os.path.join(get_home(), midori_config_dir)
    if not os.path.isdir(full_user_path):
        try:
            shutil.copytree(midori_skel, full_user_path)
        except:
            logger.error('Error copying Midori user skeleton {}'.format(midori_skel))
    # Launch midori youtube mode
    run_cmd('midori -c {}'.format(full_user_path))

    if jackd_started:
        jackd_stop()


if __name__ == '__main__':

    # This app cannot be sudoed, because we instruct Midori
    # to pull user settings
    if os.getuid() == 0:
        logger.error('This app cannot be run as root, please start it from the Desktop')
        exit(1)

    # Check if parental control is in Ultimate mode (4)
    if get_parental_level() == 4:
        # Close splash before launching dialogue
        os.system('kano-stop-splash')
        head = 'Whoops!'
        msg = "I can\'t show you videos because my parental settings are" \
            " turned on."
        dialog = KanoDialog(head, msg)
        dialog.run()
        exit(0)

    # Check if not RPi2
    if not is_model_2_b():
        # Close splash before launching dialogue
        os.system('kano-stop-splash')
        head = 'Powerup!'
        msg = "Playing video uses all of my brainpower, and sometimes" \
            " it\'s hard for me to keep up. I\'ll try, but for the best" \
            " experience upgrade my brain and get all the new powers! \n" \
            "Visit: http://powerup.kano.me/"
        dialog = KanoDialog(head, msg)
        dialog.run()
        del dialog

    # If there are VNC connected clients, show a warning message
    if os.path.isfile('/usr/bin/kano-vnc'):
        _, _, rc = run_cmd('/usr/bin/kano-vnc clients')
        if rc == 0:
            # Close splash before launching dialogue
            os.system('kano-stop-splash')
            msg = 'YouTube videos over a VNC session will be played slowly'
            kdialog = KanoDialog(
                title_text='VNC Warning',
                description_text=msg)
            response = kdialog.run()

    main()
